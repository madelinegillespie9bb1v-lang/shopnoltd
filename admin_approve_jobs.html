<?php
session_start();
require_once $_SERVER['DOCUMENT_ROOT'].'/config.html';
require_once $_SERVER['DOCUMENT_ROOT'].'/_common_rates.html';

// ✅ Check admin login
$user = $_SESSION['user'] ?? null;
if (!$user || ($user['user_role'] ?? '') !== 'admin') {
    header('Location: /login.html');
    exit;
}

// ✅ Handle approval/rejection/fine submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $job_id = intval($_POST['job_id'] ?? 0);
    $action = $_POST['action'] ?? '';
    $fine = floatval($_POST['fine'] ?? 0);

    if ($job_id && in_array($action, ['approve','reject'])) {
        if ($action === 'approve') {
            $stmt = $pdo->prepare("UPDATE jobs SET status='open', fine=? WHERE id=?");
            $stmt->execute([$fine, $job_id]);
        } elseif ($action === 'reject') {
            $stmt = $pdo->prepare("UPDATE jobs SET status='closed', fine=? WHERE id=?");
            $stmt->execute([$fine, $job_id]);
        }
        header("Location: ".$_SERVER['PHP_SELF']);
        exit;
    }
}

// ✅ Fetch pending approval jobs
$stmt = $pdo->query("SELECT j.*, u.username AS poster_username 
                     FROM jobs j 
                     JOIN users u ON j.poster_id = u.id 
                     WHERE j.status='pending_approval' 
                     ORDER BY j.created_at DESC");
$jobs = $stmt->fetchAll(PDO::FETCH_ASSOC);
?>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin – Pending Job Approvals</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
<h2 class="mb-4">Pending Job Approvals</h2>

<?php if(empty($jobs)): ?>
<div class="alert alert-info">✅ No jobs pending approval.</div>
<?php else: ?>
<table class="table table-bordered table-striped">
    <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Poster</th>
            <th>Platform</th>
            <th>Task Type</th>
            <th>Total Tasks</th>
            <th>Per Task Rate</th>
            <th>Total Amount</th>
            <th>Fine</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
    <?php foreach($jobs as $job): ?>
        <tr>
            <td><?= htmlspecialchars($job['id']) ?></td>
            <td><?= htmlspecialchars($job['poster_username']) ?></td>
            <td><?= htmlspecialchars($job['platform']) ?></td>
            <td><?= htmlspecialchars($job['task_type']) ?></td>
            <td><?= number_format($job['total_tasks']) ?></td>
            <td>$<?= number_format($job['per_task_rate'],4) ?></td>
            <td>$<?= number_format($job['total_amount'],2) ?></td>
            <td>
                <form method="post" class="d-flex gap-1 align-items-center">
                    <input type="hidden" name="job_id" value="<?= $job['id'] ?>">
                    <input type="number" step="0.01" min="0" name="fine" value="<?= $job['fine'] ?? 0 ?>" class="form-control form-control-sm" style="width:80px;">
                    <button type="submit" name="action" value="approve" class="btn btn-success btn-sm">✅ Approve</button>
                    <button type="submit" name="action" value="reject" class="btn btn-danger btn-sm">❌ Reject</button>
                </form>
            </td>
        </tr>
    <?php endforeach; ?>
    </tbody>
</table>
<?php endif; ?>

<a href="/admindashboard.html" class="btn btn-secondary mt-3">Back to Dashboard</a>
</div>
</body>
</html>
