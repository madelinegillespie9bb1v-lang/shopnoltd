<?php
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

session_start();

require_once __DIR__ . '/config.html';  // Database connection

if (isset($_SESSION['user'])) {
    $user_id = $_SESSION['user']['id'];

    // Update logout time for the latest session where log_out_time is NULL
    $stmt = $pdo->prepare("
        UPDATE logged_users 
        SET log_out_time = NOW() 
        WHERE user_id = :user_id 
          AND log_out_time IS NULL
        ORDER BY login_time DESC
        LIMIT 1
    ");
    $stmt->execute([':user_id' => $user_id]);

    // Clear all session variables
    $_SESSION = [];

    // Destroy the session
    if (ini_get("session.use_cookies")) {
        $params = session_get_cookie_params();
        setcookie(session_name(), '', time() - 42000,
            $params["path"], $params["domain"],
            $params["secure"], $params["httponly"]
        );
    }

    session_destroy();
}

// Redirect to login page
header("Location: login.html");
exit;
