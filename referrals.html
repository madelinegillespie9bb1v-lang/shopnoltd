<?php
// referrals.html
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

session_start();

require_once './config.html';
require_once './functions.html';
require_once './_common_rates.html';

// ================= AUTH CHECK =================
$user = $_SESSION['user'] ?? null;
if (!$user) {
    header('Location: /login.html');
    exit;
}

$userRole = $user['user_role'] ?? 'user';
$userId   = (int)$user['id'];
$username = $user['username'] ?? 'user';

// ---------------- BACK BUTTON LINK ----------------
$backLink = ($userRole === 'admin') ? '/admindashboard.html' : '/dashboard.html';

// Canonical referral link
$referralLink = "https://shopnoltd-dashboard.onrender.com/accounts/register/?ref=" . urlencode($username);

// ---------------- HELPER FUNCTION ----------------
function fetch_referral_data(PDO $pdo, int $userId) {
    $stmt = $pdo->prepare("
        SELECT 
            u.id, u.username, u.email, u.created_at,
            COALESCE(SUM(ut.amount),0) AS referral_earned
        FROM users u
        LEFT JOIN user_transactions ut
            ON ut.user_id = :current_user_id
            AND ut.target_user_id = u.id
            AND ut.type = 'referral_bonus'
        WHERE u.referrer_id = :current_user_id
        GROUP BY u.id, u.username, u.email, u.created_at
        ORDER BY u.created_at DESC
    ");
    $stmt->execute([':current_user_id' => $userId]);
    $referredUsers = $stmt->fetchAll(PDO::FETCH_ASSOC);
    $totalEarnings = array_sum(array_column($referredUsers, 'referral_earned'));
    return ['referredUsers'=>$referredUsers, 'totalEarnings'=>$totalEarnings];
}

// ---------------- AJAX ENDPOINT ----------------
if (isset($_GET['ajax']) && $_GET['ajax'] == '1') {
    header('Content-Type: application/json; charset=utf-8');
    $data = fetch_referral_data($pdo, $userId);
    $referredUsers = $data['referredUsers'];
    $totalEarnings = $data['totalEarnings'];

    ob_start();
    if ($referredUsers) {
        foreach ($referredUsers as $i => $u) {
            $idx = $i + 1;
            $usernameEsc = htmlspecialchars($u['username']);
            $emailEsc = htmlspecialchars($u['email']);
            $earned = number_format((float)$u['referral_earned'],2);
            $joined = htmlspecialchars($u['created_at']);
            echo "<tr>
                    <td>{$idx}</td>
                    <td>{$usernameEsc}</td>
                    <td>{$emailEsc}</td>
                    <td>\${$earned}</td>
                    <td>{$joined}</td>
                  </tr>";
        }
    } else {
        echo '<tr><td colspan="5" class="text-center text-muted">No referrals yet.</td></tr>';
    }
    $rowsHtml = ob_get_clean();

    echo json_encode([
        'count' => count($referredUsers),
        'totalEarnings' => number_format((float)$totalEarnings,4),
        'rowsHtml' => $rowsHtml
    ]);
    exit;
}

// ---------------- INITIAL PAGE DATA ----------------
$data = fetch_referral_data($pdo, $userId);
$referredUsers = $data['referredUsers'];
$totalEarnings = $data['totalEarnings'];
?>
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Referrals</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<style>
body { background-color:#f8f9fa; }
.card { border-radius:12px; }
.table-wrap { max-height:420px; overflow:auto; }
.share-btns button { margin-right: 6px; margin-top:8px; }
.small-muted { color:#6c757d; font-size:0.9rem; }
.copy-btn { width:100px; }
@media (max-width:575px){ .copy-btn{ width:80px; font-size:0.85rem } }
</style>
</head>
<body>
<div class="container py-4">

    <!-- Back Button -->
    <div class="mb-3">
        <a href="<?= htmlspecialchars($backLink) ?>" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <h2 class="mb-4 text-center">ðŸ’° Referral Dashboard</h2>

    <!-- Referral Link Card -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex align-items-start justify-content-between">
                <div>
                    <h5 class="card-title mb-1">Your Referral Link</h5>
                    <p class="small-muted mb-1">
                        Share this link with friends. You earn <?= REFERRAL_PERCENT ?>% of task earnings when they register and complete task.
                    </p>
                </div>
                <div class="text-end">
                    <button class="btn btn-outline-secondary btn-sm" id="inviteBtn" title="Invite friends">
                        <i class="bi bi-person-plus"></i> Invite
                    </button>
                </div>
            </div>

            <div class="input-group mt-2 mb-2">
                <input type="text" id="referralLink" class="form-control" value="<?= htmlspecialchars($referralLink) ?>" readonly>
                <button class="btn btn-outline-secondary copy-btn" id="copyReferralBtn">Copy</button>
            </div>

            <!-- Share Buttons -->
            <div class="share-btns">
                <button class="btn btn-success btn-sm" onclick="share('whatsapp')"><i class="bi bi-whatsapp"></i> WhatsApp</button>
                <button class="btn btn-primary btn-sm" onclick="share('telegram')"><i class="bi bi-telegram"></i> Telegram</button>
                <button class="btn btn-info btn-sm text-white" onclick="share('facebook')"><i class="bi bi-facebook"></i> Facebook</button>
                <button class="btn btn-dark btn-sm" onclick="share('x')"><i class="bi bi-x-lg"></i> X</button>
                <button class="btn btn-outline-primary btn-sm" onclick="share('email')"><i class="bi bi-envelope"></i> Email</button>
                <button class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#qrModal"><i class="bi bi-upc-scan"></i> QR</button>
            </div>
        </div>
    </div>

    <!-- Referral Summary -->
    <div class="row g-3 mb-4 text-center" id="summaryRow">
        <div class="col-md-4 col-sm-6">
            <div class="card p-3 shadow-sm">
                <h3 id="totalReferred"><?= count($referredUsers) ?></h3>
                <small>Total Referred Users</small>
            </div>
        </div>
        <div class="col-md-4 col-sm-6">
            <div class="card p-3 shadow-sm">
                <h3>$<span id="totalEarnings"><?= number_format((float)$totalEarnings,2) ?></span></h3>
                <small>Total Referral Earnings</small>
            </div>
        </div>
    </div>

    <!-- Referred Users Table -->
    <div class="card p-3 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Users You Referred</h5>
            <small class="text-muted">Referral credit per user</small>
        </div>
        <div class="table-wrap">
            <table class="table table-sm table-bordered table-hover">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Referral Credit Earned</th>
                        <th>Joined</th>
                    </tr>
                </thead>
                <tbody id="referredRows">
                <?php if($referredUsers): ?>
                    <?php foreach($referredUsers as $i => $u): ?>
                    <tr>
                        <td><?= $i+1 ?></td>
                        <td><?= htmlspecialchars($u['username']) ?></td>
                        <td><?= htmlspecialchars($u['email']) ?></td>
                        <td>$<?= number_format($u['referral_earned'],2) ?></td>
                        <td><?= htmlspecialchars($u['created_at']) ?></td>
                    </tr>
                    <?php endforeach; ?>
                <?php else: ?>
                    <tr><td colspan="5" class="text-center text-muted">No referrals yet.</td></tr>
                <?php endif; ?>
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="qrModalLabel">Share via QR Code</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <canvas id="qrCanvas" style="max-width:100%;"></canvas>
        <p class="mt-3 small-muted">Scan this QR to open your referral link.</p>
        <div class="d-flex justify-content-center mt-2">
            <button class="btn btn-outline-secondary btn-sm me-2" id="downloadQrBtn">Download QR</button>
            <button class="btn btn-primary btn-sm" id="shareNativeBtn">Share (Native)</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JS Libraries -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

<script>
const referralLinkValue = document.getElementById('referralLink').value;
const pollIntervalMs = 20000;

// Copy referral link
$('#copyReferralBtn').on('click', function(){
    navigator.clipboard.writeText(referralLinkValue).then(()=>{
        $(this).text('Copied!');
        setTimeout(()=>$(this).text('Copy'),1500);
    }).catch(()=>alert('Copy failed.'));
});

// Share handlers
function share(channel){
    const url = referralLinkValue;
    const text = `Join Shopnoltd: ${url}`;
    if(navigator.share){
        navigator.share({ title:'Join Shopnoltd', text:'Join Shopnoltd using my link', url });
        return;
    }
    switch(channel){
        case 'whatsapp': window.open(`https://wa.me/?text=${encodeURIComponent(text)}`); break;
        case 'telegram': window.open(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=Join%20Shopnoltd`); break;
        case 'facebook': window.open(`https://www.facebook.com/sharer/sharer.html?u=${encodeURIComponent(url)}`); break;
        case 'x': window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`); break;
        case 'email': window.location.href=`mailto:?subject=Join%20Shopnoltd&body=${encodeURIComponent('Sign up: '+url)}`; break;
    }
}

// Invite button
document.getElementById('inviteBtn').addEventListener('click', function(){
    if(navigator.share){
        navigator.share({ title:'Join Shopnoltd', text:'Join Shopnoltd using my link', url:referralLinkValue });
    } else {
        new bootstrap.Modal(document.getElementById('qrModal')).show();
    }
});

// QR code
const qrCanvas = document.getElementById('qrCanvas');
QRCode.toCanvas(qrCanvas, referralLinkValue, { width:260 }, function(err){ if(err) console.error(err); });

// Download QR
document.getElementById('downloadQrBtn').addEventListener('click', function(){
    const link=document.createElement('a');
    link.href=qrCanvas.toDataURL('image/png');
    link.download='shopnoltd-referral.png';
    link.click();
});

// Native QR share
document.getElementById('shareNativeBtn').addEventListener('click', async function(){
    if(!navigator.canShare) return alert('Native share not supported.');
    qrCanvas.toBlob(async blob=>{
        const file=new File([blob],'referral-qr.png',{type:'image/png'});
        try { await navigator.share({ files:[file], title:'Join Shopnoltd', text:'Scan to join' }); }
        catch(e){ console.warn(e); alert('Native sharing failed.'); }
    });
});

// Polling updates
async function pollData(){
    try{
        const res = await fetch('?ajax=1',{cache:'no-store'});
        if(!res.ok) throw new Error('Network response not ok');
        const json = await res.json();
        $('#totalReferred').text(json.count);
        $('#totalEarnings').text(json.totalEarnings);
        $('#referredRows').html(json.rowsHtml);
    }catch(e){console.warn(e);}
}
setInterval(pollData, pollIntervalMs);
setTimeout(pollData,5000);
</script>
</body>
</html>
