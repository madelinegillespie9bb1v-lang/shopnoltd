<?php
session_start();
require_once '../../config.html';

// Collect form data
$username    = trim($_POST['username'] ?? '');
$email       = trim($_POST['email'] ?? '');
$phoneCode   = trim($_POST['phone_code'] ?? '');  // ✅ fixed here
$phone       = trim($_POST['phone'] ?? '');
$password    = trim($_POST['password'] ?? '');

// Check for missing fields
if (empty($username) || empty($email) || empty($phoneCode) || empty($phone) || empty($password)) {
    die("⚠️ Please fill in all required fields.");
}

try {
    // Check if user exists with all provided details
    $stmt = $pdo->prepare("SELECT * FROM users 
        WHERE username = :username 
        AND email = :email 
        AND phone_code = :phone_code 
        AND phone = :phone 
        LIMIT 1");
    $stmt->execute([
        'username' => $username,
        'email' => $email,
        'phone_code' => $phoneCode,
        'phone' => $phone
    ]);

    $user = $stmt->fetch(PDO::FETCH_ASSOC);

    if ($user) {
        // Verify password
        if (password_verify($password, $user['password'])) {
            $_SESSION['user_id'] = $user['id'];
            $_SESSION['username'] = $user['username'];
            $_SESSION['language'] = $user['language'] ?? 'English';
            
            header("Location: ../../profile/index.html");
            exit;
        } else {
            echo "<p style='color:red;'>❌ Incorrect password.</p>";
            echo "<a href='index.html'>Go back</a>";
        }
    } else {
        echo "<p style='color:red;'>❌ No account found matching the entered details.</p>";
        echo "<a href='index.html'>Go back</a>";
    }
} catch (PDOException $e) {
    echo "Database error: " . htmlspecialchars($e->getMessage());
}


    // ✅ Generate a random 6-digit OTP
    $otp = rand(100000, 999999);

    // ✅ Store temporary data in session
    $_SESSION['pending_user'] = [
        'username'   => $username,
        'email'      => $email,
        'phone_code' => $phone_code,
        'phone'      => $phone,
        'password'   => $password,
        'language'   => $language,
        'otp'        => $otp
    ];

    // ✅ Simulate sending OTP (later you can integrate WhatsApp or email)
    // For now, show OTP on next page for testing
    header("Location: verify_otp.html");
    exit;
}
?>
