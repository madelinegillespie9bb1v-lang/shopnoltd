<?php
session_start();
require_once $_SERVER['DOCUMENT_ROOT'] . '/config.html';
require_once $_SERVER['DOCUMENT_ROOT'] . '/_common_rates_worker.html';

// ================== CHECK LOGIN ==================
$current_user = $_SESSION['user'] ?? null;
if (!$current_user) {
    header('Location: /login.html');
    exit;
}

$user_id   = $current_user['id'];
$user_role = $current_user['user_role'] ?? 'user';

// ================== REFRESH USER BALANCE ==================
$stmt = $pdo->prepare("SELECT id, username, user_role, balance, email FROM users WHERE id = ?");
$stmt->execute([$user_id]);
$dbUser = $stmt->fetch(PDO::FETCH_ASSOC);
if (!$dbUser) {
    session_destroy();
    header('Location: /login.html');
    exit;
}

$username     = $dbUser['username'];
$user_role    = $dbUser['user_role'];
$user_balance = floatval($dbUser['balance']);

// ================== GET PLATFORM & TASK ==================
$platform  = $_GET['platform'] ?? '';
$task_type = $_GET['task_type'] ?? '';
if (!$platform || !$task_type) {
    header('Location: post_job.html?error=no_platform');
    exit;
}

// ================== GET BASE RATE & INSTRUCTION ==================
$base_rate   = getTaskRate($platform, $task_type);
$instruction = getTaskInstruction($platform, $task_type);
$split       = calculateSplit($base_rate); // ['worker'=>..,'admin'=>..,'referral'=>..]

// ================== DEFAULTS ==================
$total_tasks    = intval($_POST['total_tasks'] ?? 1);
$target_value   = intval($_POST['target_value'] ?? 0);
$existing_value = intval($_POST['existing_value'] ?? 0);
$screenshot     = '';
$screenshot_valid = false;
$errors         = [];
$success        = '';

// ================== HANDLE FORM SUBMISSION ==================
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $title        = trim($_POST['title'] ?? '');
    $description  = trim($_POST['description'] ?? '');
    $link         = trim($_POST['link'] ?? '');
    $target_value   = intval($_POST['target_value'] ?? 0);
    $existing_value = intval($_POST['existing_value'] ?? 0);
    $total_tasks    = max(1, $target_value - $existing_value);

    if (empty($link)) $errors[] = "Job link is required.";

    // --- Screenshot handling ---
    $screenshot_file   = $_FILES['screenshot'] ?? null;
    $screenshot_base64 = $_POST['screenshot_base64'] ?? null;

    $safe_platform = preg_replace('/[^a-zA-Z0-9_-]/', '_', $platform);
    $safe_category = preg_replace('/[^a-zA-Z0-9_-]/', '_', $task_type);
    $parsed_url = parse_url($link);
    $host = $parsed_url['host'] ?? 'link';
    $path = $parsed_url['path'] ?? '';
    $query = $parsed_url['query'] ?? '';
    $full_link = $host . $path . ($query ? "?$query" : '');
    $jobLinkFolder = preg_replace('/[^a-zA-Z0-9_-]/', '_', $full_link);
    $jobLinkFolder = trim($jobLinkFolder, '_') ?: 'link';
    $timestamp = date('Y-m-d_His');
    $upload_dir = __DIR__ . "/uploads/job_post_form/$username/$safe_platform/$safe_category/$jobLinkFolder/$timestamp/";
    $upload_url = "/uploads/job_post_form/$username/$safe_platform/$safe_category/$jobLinkFolder/$timestamp/";
    if (!is_dir($upload_dir)) mkdir($upload_dir, 0777, true);

    if ($screenshot_file && isset($screenshot_file['tmp_name']) && is_uploaded_file($screenshot_file['tmp_name'])) {
        $filename = basename($screenshot_file['name']);
        $target_file = $upload_dir . $filename;
        if (move_uploaded_file($screenshot_file['tmp_name'], $target_file)) {
            $screenshot = $upload_url . $filename;
            $screenshot_valid = true;
        } else {
            $errors[] = "❌ Failed to upload screenshot.";
        }
    } elseif ($screenshot_base64 && preg_match('/^data:image\/(\w+);base64,/', $screenshot_base64, $type)) {
        $type = strtolower($type[1]);
        $data = base64_decode(substr($screenshot_base64, strpos($screenshot_base64, ',') + 1));
        $filename = "screenshot.$type";
        $target_file = $upload_dir . $filename;
        if (file_put_contents($target_file, $data)) {
            $screenshot = $upload_url . $filename;
            $screenshot_valid = true;
        } else {
            $errors[] = "❌ Failed to save pasted screenshot.";
        }
    }

    // --- Total & Balance ---
    $total_amount = round($total_tasks * $base_rate, 4);
    $per_task_worker_rate   = $split['worker'];
    $per_task_admin_rate    = $split['admin'];
    $per_task_referral_rate = $split['referral'];
    $total_worker_amount   = round($total_tasks * $per_task_worker_rate, 4);
    $total_admin_amount    = round($total_tasks * $per_task_admin_rate, 4);
    $total_referral_amount = round($total_tasks * $per_task_referral_rate, 4);

    // --- Strict balance check ---
    $shortfall = 0;
    if ($user_role === 'user' && $user_balance < $total_amount) {
        $shortfall = $total_amount - $user_balance;
        $job_status = 'pending_approval';
        $errors[] = "⚠️ Insufficient balance ($" . number_format($shortfall,4) . "). Admin approval required.";
    } else {
        $job_status = 'open';
    }

    // --- Save or update job ---
    if (empty($errors) || $job_status === 'open') {
        try {
            $checkStmt = $pdo->prepare("
                SELECT id, status FROM jobs
                WHERE poster_id = ? AND link = ?
                AND status NOT IN ('completed', 'closed')
                ORDER BY id DESC LIMIT 1
            ");
            $checkStmt->execute([$user_id, $link]);
            $existingJob = $checkStmt->fetch(PDO::FETCH_ASSOC);

            $pdo->beginTransaction();

            if ($existingJob) {
                $job_id = $existingJob['id'];
                $stmt = $pdo->prepare("SELECT approved_tasks FROM jobs WHERE id=?");
                $stmt->execute([$job_id]);
                $approved_tasks = intval($stmt->fetchColumn() ?? 0);

                $pending_tasks = max(0, $total_tasks - $approved_tasks);
                $remaining_tasks = $pending_tasks;

                $updateJob = $pdo->prepare("
                    UPDATE jobs SET
                        title=?, description=?, screenshot=?, existing_value=?, target_value=?,
                        total_tasks=?, per_task_rate=?, worker_rate=?, admin_rate=?, referral_rate=?,
                        per_task_worker_rate=?, per_task_admin_rate=?, per_task_referral_rate=?,
                        total_amount=?, total_worker_amount=?, total_admin_amount=?, total_referral_amount=?,
                        instruction=?, pending_tasks=?, remaining_tasks=?, status=?, updated_at=NOW()
                    WHERE id=?
                ");
                $updateJob->execute([
                    $title, $description, $screenshot, $existing_value, $target_value,
                    $total_tasks, $base_rate, $per_task_worker_rate + $per_task_admin_rate,
                    $per_task_admin_rate, $per_task_referral_rate,
                    $per_task_worker_rate, $per_task_admin_rate, $per_task_referral_rate,
                    $total_amount, $total_worker_amount, $total_admin_amount, $total_referral_amount,
                    $instruction, $pending_tasks, $remaining_tasks, $job_status, $job_id
                ]);

                $success = "✅ Existing job updated successfully (Job ID: $job_id, Status: $job_status)";
            } else {
                $approved_tasks = 0;
                $pending_tasks = $total_tasks;
                $remaining_tasks = $total_tasks;

                $insertJob = $pdo->prepare("
                    INSERT INTO jobs
                    (poster_id, platform, task_type, title, description, link, screenshot, existing_value, target_value,
                    total_tasks, per_task_rate, worker_rate, admin_rate, referral_rate,
                    per_task_worker_rate, per_task_admin_rate, per_task_referral_rate,
                    total_amount, total_worker_amount, total_admin_amount, total_referral_amount,
                    instruction, approved_tasks, pending_tasks, remaining_tasks,
                    status, created_at, updated_at)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW(), NOW())
                ");
                $insertJob->execute([
                    $user_id, $platform, $task_type, $title, $description, $link, $screenshot,
                    $existing_value, $target_value, $total_tasks, $base_rate,
                    $per_task_worker_rate, $per_task_admin_rate, $per_task_referral_rate,
                    $per_task_worker_rate, $per_task_admin_rate, $per_task_referral_rate,
                    $total_amount, $total_worker_amount, $total_admin_amount, $total_referral_amount,
                    $instruction, $approved_tasks, $pending_tasks, $remaining_tasks,
                    $job_status
                ]);

                // Deduct balance only if job is open
                if ($job_status === 'open') {
                    $update = $pdo->prepare("UPDATE users SET balance = balance - ? WHERE id = ?");
                    $update->execute([$total_amount, $user_id]);
                }

                $success = "✅ Job posted successfully! Status: $job_status";
            }

            $pdo->commit();
        } catch (PDOException $e) {
            $pdo->rollBack();
            $errors[] = "Database error: " . $e->getMessage();
        }
    }
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Post Job – <?= htmlspecialchars($platform) ?> / <?= htmlspecialchars($task_type) ?></title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<style>
#previewImg { max-width: 100%; border:2px solid #ccc; margin-top:10px; cursor:pointer; border-radius:8px; transition:0.3s; }
#previewImg.valid { border-color:green; }
#previewImg.invalid { border-color:red; }
.instruction-box { background:#fdfdfd; border:1px solid #ddd; padding:10px 15px; border-radius:8px; margin-bottom:15px; }
</style>
</head>
<body>
<div class="container py-4">
<h2>Post Job – <?= htmlspecialchars($platform) ?> / <?= htmlspecialchars($task_type) ?></h2>
<a href="select_task_category.html?platform=<?= urlencode($platform) ?>" class="btn btn-outline-secondary mb-3">&larr; Back</a>

<?php if ($errors): ?>
<div class="alert alert-danger"><ul><?php foreach ($errors as $e) echo "<li>".htmlspecialchars($e)."</li>"; ?></ul></div>
<?php endif; ?>
<?php if ($success): ?>
<div class="alert alert-success"><?= htmlspecialchars($success) ?></div>
<?php endif; ?>

<div class="instruction-box"><?= nl2br(htmlspecialchars($instruction)) ?></div>

<form method="post" enctype="multipart/form-data">
<div class="mb-3"><label>Job Title</label><input type="text" name="title" class="form-control" value="<?= htmlspecialchars($_POST['title'] ?? '') ?>"></div>
<div class="mb-3"><label>Description</label><textarea name="description" class="form-control"><?= htmlspecialchars($_POST['description'] ?? '') ?></textarea></div>
<div class="mb-3"><label>Job Link *</label><input type="url" name="link" class="form-control" required value="<?= htmlspecialchars($_POST['link'] ?? '') ?>"></div>

<div class="mb-3">
<label>Screenshot (Upload or Ctrl+V Paste)</label>
<input type="file" id="screenshotInput" name="screenshot" accept="image/*" class="form-control">
<input type="hidden" id="screenshotBase64" name="screenshot_base64">
<button type="button" id="deleteScreenshotBtn" class="btn btn-danger btn-sm mt-2">Delete Screenshot</button>
<img id="previewImg" src="<?= htmlspecialchars($screenshot) ?>" class="<?= $screenshot_valid?'valid':'invalid' ?>" alt="Screenshot Preview">
</div>

<div class="mb-3">
<label>Existing Value</label>
<input type="number" name="existing_value" id="existingValue" class="form-control" value="<?= $existing_value ?>">
</div>
<div class="mb-3">
<label>Target Value *</label>
<input type="number" name="target_value" id="targetValue" class="form-control" value="<?= $target_value ?>" required>
</div>

<div class="mb-3">
<label>Total Tasks</label>
<input type="text" id="totalTasks" class="form-control" readonly>
</div>

<div class="mb-3"><label>Base Rate ($)</label>
<input type="text" id="baseRate" class="form-control" readonly value="<?= number_format($base_rate, 4) ?>"></div>
<div class="mb-3"><label>Worker Rate ($)</label>
<input type="text" id="workerRate" class="form-control" readonly></div>
<div class="mb-3"><label>Admin Rate ($)</label>
<input type="text" id="adminRate" class="form-control" readonly></div>
<div class="mb-3"><label>Referral Rate ($)</label>
<input type="text" id="referralRate" class="form-control" readonly></div>
<div class="mb-3"><label>Total Amount ($)</label>
<input type="text" id="totalAmount" class="form-control" readonly></div>
<div class="mb-3">
<label>Your Balance ($)</label>
<input type="text" class="form-control" readonly value="<?= number_format($user_balance, 4) ?>">
</div>

<button type="submit" class="btn btn-primary w-100">Post Job</button>
</form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const baseRate = <?= $base_rate ?>;
const workerRate = <?= $split['worker'] ?>;
const adminRate = <?= $split['admin'] ?>;
const referralRate = <?= $split['referral'] ?>;

function updateTotals(){
    let existing = parseInt($('#existingValue').val()) || 0;
    let target = parseInt($('#targetValue').val()) || 0;
    let total = Math.max(1, target - existing);
    $('#totalTasks').val(total);

    let totalAmount = (total * baseRate).toFixed(4);
    let workerTotal = (total * workerRate).toFixed(4);
    let adminTotal = (total * adminRate).toFixed(4);
    let referralTotal = (total * referralRate).toFixed(4);

    $('#totalAmount').val(totalAmount);
    $('#workerRate').val(workerRate.toFixed(4) + " (Total: " + workerTotal + ")");
    $('#adminRate').val(adminRate.toFixed(4) + " (Total: " + adminTotal + ")");
    $('#referralRate').val(referralRate.toFixed(4) + " (Total: " + referralTotal + ")");
}

$('#existingValue,#targetValue').on('input', updateTotals);
updateTotals();

// --- Ctrl+V screenshot paste ---
$(document).on('paste', function(e){
    let items = (e.originalEvent.clipboardData || e.clipboardData).items;
    for(let i=0;i<items.length;i++){
        if(items[i].type.indexOf('image')!==-1){
            let blob = items[i].getAsFile();
            let reader = new FileReader();
            reader.onload = function(event){
                $('#previewImg').attr('src', event.target.result).addClass('valid');
                $('#screenshotBase64').val(event.target.result);
            };
            reader.readAsDataURL(blob);
        }
    }
});
$('#deleteScreenshotBtn').click(function(){
    $('#previewImg').attr('src','').removeClass('valid invalid');
    $('#screenshotBase64').val('');
});
</script>
</body>
</html>
