<?php
session_start();
require_once $_SERVER['DOCUMENT_ROOT'].'/config.html';
require_once $_SERVER['DOCUMENT_ROOT'].'/_common_rates_worker.html';

// ================== CHECK ADMIN LOGIN ==================
$current_user = $_SESSION['user'] ?? null;
if (!$current_user || $current_user['user_role'] !== 'admin') {
    die("❌ Access denied. Admins only.");
}

// ================== HANDLE JOB/TASK ACTIONS ==================
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['task_id'], $_POST['action'])) {
    $task_id = intval($_POST['task_id']);
    $action = $_POST['action'];
    if ($action === 'approve_task') {
        $stmt = $pdo->prepare("UPDATE job_work SET status='approved', approved_at=NOW() WHERE id=?");
        $stmt->execute([$task_id]);
    } elseif ($action === 'reject_task') {
        $stmt = $pdo->prepare("UPDATE job_work SET status='rejected', approved_at=NOW() WHERE id=?");
        $stmt->execute([$task_id]);
    }
    header('Location: admin_jobs.html');
    exit;
}

if (isset($_GET['action'], $_GET['id'])) {
    $id = intval($_GET['id']);
    $action = $_GET['action'];
    
    if ($action === 'approve_job') {
        $stmt = $pdo->prepare("UPDATE jobs SET status='open' WHERE id=? AND status='pending_approval'");
        $stmt->execute([$id]);
    } elseif ($action === 'close_job') {
        $stmt = $pdo->prepare("UPDATE jobs SET status='closed' WHERE id=?");
        $stmt->execute([$id]);
    } elseif ($action === 'delete_job') {
        $stmt = $pdo->prepare("DELETE FROM jobs WHERE id=?");
        $stmt->execute([$id]);
    } elseif ($action === 'upload_proof' && isset($_FILES['proof_file'])) {
        $file = $_FILES['proof_file'];
        if ($file && is_uploaded_file($file['tmp_name'])) {
            $ext = pathinfo($file['name'], PATHINFO_EXTENSION);
            $safe_name = "proof_" . time() . "." . $ext;
            $upload_dir = $_SERVER['DOCUMENT_ROOT'] . "/uploads/admin_proof/";
            if (!is_dir($upload_dir)) mkdir($upload_dir, 0777, true);
            $target_file = $upload_dir . $safe_name;
            if (move_uploaded_file($file['tmp_name'], $target_file)) {
                $stmt = $pdo->prepare("UPDATE jobs SET proof_screenshot=? WHERE id=?");
                $stmt->execute(["/uploads/admin_proof/".$safe_name, $id]);
            }
        }
    }
    header('Location: admin_jobs.html');
    exit;
}

// ================== FETCH JOBS ==================
$filter = $_GET['filter'] ?? 'all';
$where = '1';
if ($filter === 'pending') $where = "status='pending_approval'";
elseif ($filter === 'open') $where = "status='open'";
elseif ($filter === 'closed') $where = "status='closed'";

$stmt = $pdo->prepare("
    SELECT j.*, u.username AS poster_username, u.email AS poster_email
    FROM jobs j
    JOIN users u ON j.poster_id = u.id
    WHERE $where
    ORDER BY j.created_at DESC
");
$stmt->execute();
$jobs = $stmt->fetchAll(PDO::FETCH_ASSOC);

// ================== COUNTS ==================
$totalCount = (int)$pdo->query("SELECT COUNT(*) FROM jobs")->fetchColumn();
$pendingCount = (int)$pdo->query("SELECT COUNT(*) FROM jobs WHERE status='pending_approval'")->fetchColumn();
$openCount = (int)$pdo->query("SELECT COUNT(*) FROM jobs WHERE status='open'")->fetchColumn();
$closedCount = (int)$pdo->query("SELECT COUNT(*) FROM jobs WHERE status='closed'")->fetchColumn();
?>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin – Manage Jobs</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background-color: #f8fafc; }
.container { background: #fff; border-radius: 10px; padding: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
.table thead { background: #2563eb; color: white; }
.badge { font-size: 0.8rem; }
img.screenshot { max-width: 120px; max-height: 80px; border:1px solid #ccc; border-radius:4px; cursor:pointer; }
.submission { background:#f9f9f9; padding:5px; border-radius:5px; margin-bottom:5px; }
.modal { display:none; position:fixed; z-index:1050; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
.modal img { max-width:90%; max-height:90%; border:3px solid #fff; border-radius:6px; }
.modal-close { position:absolute; top:10px; right:20px; font-size:2rem; color:white; cursor:pointer; }
</style>
</head>
<body>
<div class="container my-4">
<h2 class="mb-3">Admin Job Management</h2>
<a href="/admindashboard.html" class="btn btn-secondary mb-3">&larr; Back to Dashboard</a>

<div class="mb-3">
  <a href="?filter=all" class="btn btn-outline-primary btn-sm <?= $filter==='all'?'active':'' ?>">All (<?= $totalCount ?>)</a>
  <a href="?filter=pending" class="btn btn-outline-warning btn-sm <?= $filter==='pending'?'active':'' ?>">Pending (<?= $pendingCount ?>)</a>
  <a href="?filter=open" class="btn btn-outline-success btn-sm <?= $filter==='open'?'active':'' ?>">Open (<?= $openCount ?>)</a>
  <a href="?filter=closed" class="btn btn-outline-secondary btn-sm <?= $filter==='closed'?'active':'' ?>">Closed (<?= $closedCount ?>)</a>
</div>

<?php if (!$jobs): ?>
<div class="alert alert-info">No jobs found.</div>
<?php else: ?>
<div class="table-responsive">
<table class="table table-bordered align-middle">
<thead>
<tr>
  <th>#</th>
  <th>Poster</th>
  <th>Platform</th>
  <th>Category</th>
  <th>Title</th>
  <th>Total Tasks</th>
  <th>Rates ($)</th>
  <th>Submissions</th>
  <th>Proof</th>
  <th>Status</th>
  <th>Action</th>
</tr>
</thead>
<tbody>
<?php foreach($jobs as $i => $job): ?>
<tr>
  <td><?= $i+1 ?></td>
  <td><?= htmlspecialchars($job['poster_username']) ?><br><small><?= htmlspecialchars($job['poster_email']) ?></small></td>
  <td><?= htmlspecialchars($job['platform']) ?></td>
  <td><?= htmlspecialchars($job['task_type']) ?></td>
  <td><?= htmlspecialchars($job['title'] ?: '-') ?></td>
  <td>
      <?= (int)$job['total_tasks'] ?><br>
      <small>Remaining: <?= (int)$job['remaining_tasks'] ?></small>
  </td>
  <td>
      Worker: $<?= number_format($job['worker_rate'],4) ?><br>
      Admin: $<?= number_format($job['admin_rate'],4) ?><br>
      Referrer: $<?= number_format($job['referrer_rate'],4) ?>
  </td>
  <td>
    <?php
    $stmt2 = $pdo->prepare("SELECT * FROM job_work WHERE job_id=? ORDER BY submitted_at DESC");
    $stmt2->execute([$job['id']]);
    $works = $stmt2->fetchAll(PDO::FETCH_ASSOC);
    if($works):
        foreach($works as $w):
    ?>
    <div class="submission">
        <strong><?= htmlspecialchars($w['worker_username']) ?></strong> (<?= $w['status'] ?>)<br>
        Before:<br>
        <?php if($w['screenshot_before']): ?>
            <img src="<?= htmlspecialchars($w['screenshot_before']) ?>" class="screenshot" onclick="openModal('<?= htmlspecialchars($w['screenshot_before']) ?>')">
        <?php else: ?>N/A<?php endif; ?><br>
        After:<br>
        <?php if($w['screenshot_after']): ?>
            <img src="<?= htmlspecialchars($w['screenshot_after']) ?>" class="screenshot" onclick="openModal('<?= htmlspecialchars($w['screenshot_after']) ?>')">
        <?php else: ?>N/A<?php endif; ?><br>
        <form method="post" class="mt-1">
            <input type="hidden" name="task_id" value="<?= $w['id'] ?>">
            <button type="submit" name="action" value="approve_task" class="btn btn-success btn-sm" <?= $w['status']==='approved'?'disabled':'' ?>>Approve</button>
            <button type="submit" name="action" value="reject_task" class="btn btn-danger btn-sm" <?= $w['status']==='rejected'?'disabled':'' ?>>Reject</button>
        </form>
    </div>
    <?php
        endforeach;
    else:
        echo "No submissions";
    endif;
    ?>
  </td>
  <td>
    <?php if($job['proof_screenshot']): ?>
        <img src="<?= htmlspecialchars($job['proof_screenshot']) ?>" class="screenshot" onclick="openModal('<?= htmlspecialchars($job['proof_screenshot']) ?>')">
    <?php else: ?>
        <form method="post" enctype="multipart/form-data">
            <input type="file" name="proof_file" accept="image/*" class="form-control form-control-sm mb-1">
            <button type="submit" formaction="?action=upload_proof&id=<?= $job['id'] ?>" class="btn btn-primary btn-sm">Upload Proof</button>
        </form>
    <?php endif; ?>
  </td>
  <td>
    <?php if ($job['status']==='open'): ?>
      <span class="badge bg-success">Open</span>
    <?php elseif ($job['status']==='pending_approval'): ?>
      <span class="badge bg-warning text-dark">Pending</span>
    <?php elseif ($job['status']==='closed'): ?>
      <span class="badge bg-secondary">Closed</span>
    <?php else: ?>
      <span class="badge bg-info"><?= htmlspecialchars($job['status']) ?></span>
    <?php endif; ?>
  </td>
  <td>
    <div class="btn-group btn-group-sm">
      <?php if ($job['status']==='pending_approval'): ?>
        <a href="?action=approve_job&id=<?= $job['id'] ?>" class="btn btn-outline-success" onclick="return confirm('Approve this job?')">Approve Job</a>
      <?php endif; ?>
      <?php if ($job['status']==='open'): ?>
        <a href="?action=close_job&id=<?= $job['id'] ?>" class="btn btn-outline-warning" onclick="return confirm('Close this job?')">Close</a>
      <?php endif; ?>
      <a href="?action=delete_job&id=<?= $job['id'] ?>" class="btn btn-outline-danger" onclick="return confirm('Delete this job?')">Delete</a>
    </div>
  </td>
</tr>
<?php endforeach; ?>
</tbody>
</table>
</div>
<?php endif; ?>

<!-- Screenshot Modal -->
<div id="screenshotModal" class="modal" onclick="closeModal()">
    <span class="modal-close" onclick="closeModal()">×</span>
    <img id="modalImage" src="">
</div>
<script>
function openModal(src){
    document.getElementById('modalImage').src = src;
    document.getElementById('screenshotModal').style.display = 'flex';
}
function closeModal(){
    document.getElementById('screenshotModal').style.display = 'none';
}
</script>

</div>
</body>
</html>
