<?php  
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

session_start();

require_once __DIR__ . '/config.html';
require_once __DIR__ . '/functions.html';

try {

    if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
        throw new Exception("Invalid request.");
    }

    // -------------------------
    // Capture Form Data
    // -------------------------
    $login_id   = trim($_POST['login_id'] ?? '');
    $password   = trim($_POST['password'] ?? '');
    $login_time = $_POST['login_time'] ?? date("Y-m-d H:i:s");

    if (empty($login_id) || empty($password)) {
        throw new Exception("Login ID & Password required.");
    }

    // -------------------------
    // Device + IP Info
    // -------------------------
    $device_name   = $_POST['device_name'] ?? 'Unknown';
    $device_model  = $_POST['device_model'] ?? 'Unknown';
    $device_os     = $_POST['device_os'] ?? 'Unknown';
    $browser_name  = $_POST['browser_name'] ?? 'Unknown';
    $user_agent    = $_POST['user_agent'] ?? ($_SERVER['HTTP_USER_AGENT'] ?? 'Unknown');
    $ip_address    = $_POST['ip_address'] ?? ($_SERVER['REMOTE_ADDR'] ?? 'Unknown');
    $ip_port       = $_POST['ip_port'] ?? ($_SERVER['REMOTE_PORT'] ?? '');
    $login_country = $_POST['login_country'] ?? 'Unknown';
    $country_code  = $_POST['country_code'] ?? 'Unknown';

    // -------------------------
    // Detect if login is Phone or Username/Email
    // -------------------------
    if (preg_match('/^\+?\d+$/', $login_id)) {

        $phoneOnly = preg_replace('/^\+/', '', $login_id);

        $stmt = $pdo->prepare("
            SELECT * FROM users
            WHERE 
                phone = :phone 
                OR fullphone = :fullphone
            LIMIT 1
        ");

        $stmt->execute([
            ':phone' => $phoneOnly,
            ':fullphone' => $login_id
        ]);

    } else {

        $stmt = $pdo->prepare("
            SELECT * FROM users 
            WHERE username = :login_id OR email = :login_id
            LIMIT 1
        ");

        $stmt->execute([':login_id' => $login_id]);
    }

    $user = $stmt->fetch(PDO::FETCH_ASSOC);

    if (!$user) {
        throw new Exception("Invalid login credentials.");
    }

    // -------------------------
    // Verify Password
    // -------------------------
    if (!password_verify($password, $user['password'])) {
        throw new Exception("Incorrect password.");
    }

    // -------------------------
    // Update Device Info (if changed)
    // -------------------------
    $updateDevice = $pdo->prepare("
        UPDATE users SET 
            device_name = :device_name,
            device_model = :device_model,
            device_os = :device_os,
            browser_name = :browser_name,
            user_agent = :user_agent,
            last_login_time = :last_login_time
        WHERE id = :id
    ");

    $updateDevice->execute([
        ':device_name' => $device_name,
        ':device_model' => $device_model,
        ':device_os' => $device_os,
        ':browser_name' => $browser_name,
        ':user_agent' => $user_agent,
        ':last_login_time' => $login_time,
        ':id' => $user['id']
    ]);

    // -------------------------
    // LOG LOGIN ACTIVITY - logged_users table
    // -------------------------
    $insertLog = $pdo->prepare("
        INSERT INTO logged_users 
        (user_id, username, email, phone_code, phone, fullphone,
         ip_address, ip_port, login_time, login_country,
         browser, device_type, device_name, device_model,
         device_os, browser_name, user_agent, country_code)
        VALUES 
        (:user_id, :username, :email, :phone_code, :phone, :fullphone,
         :ip_address, :ip_port, :login_time, :login_country,
         :browser, :device_type, :device_name, :device_model,
         :device_os, :browser_name, :user_agent, :country_code)
    ");

    $insertLog->execute([
        ':user_id'      => $user['id'],
        ':username'     => $user['username'],
        ':email'        => $user['email'],
        ':phone_code'   => $user['phone_code'],
        ':phone'        => $user['phone'],
        ':fullphone'    => $user['fullphone'],
        ':ip_address'   => $ip_address,
        ':ip_port'      => $ip_port,
        ':login_time'   => $login_time,
        ':login_country'=> $login_country,
        ':browser'      => $browser_name,
        ':device_type'  => $device_os,  // OS = type
        ':device_name'  => $device_name,
        ':device_model' => $device_model,
        ':device_os'    => $device_os,
        ':browser_name' => $browser_name,
        ':user_agent'   => $user_agent,
        ':country_code' => $country_code
    ]);

    // -------------------------
    // Generate OTP for login
    // -------------------------
    $otp_number = rand(100000, 999999);
    $otp_time = time();
    $otp_valid_minutes = 5;
    $otp_end_time = $otp_time + ($otp_valid_minutes * 60);

    $updateOtp = $pdo->prepare("
        UPDATE users SET 
            generated_otp_number = :otp,
            generated_otp_time = :time,
            generated_otp_end_time = :end_time,
            generated_otp_count_time = :count
        WHERE id = :id
    ");

    $updateOtp->execute([
        ':otp' => $otp_number,
        ':time' => $otp_time,
        ':end_time' => $otp_end_time,
        ':count' => $otp_valid_minutes,
        ':id' => $user['id']
    ]);

    // -------------------------
    // Save OTP in SESSION
    // -------------------------
    $_SESSION['pending_user'] = [
        'id' => $user['id'],
        'username' => $user['username'],
        'email' => $user['email'],
        'phone_code' => $user['phone_code'],
        'phone' => $user['phone'],
        'fullphone' => $user['fullphone'],
        'user_role' => $user['user_role'],
        'generated_otp_number' => $otp_number,
        'generated_otp_end_time' => $otp_end_time
    ];

    // -------------------------
    // Redirect to OTP screen
    // -------------------------
    header("Location: verify_otp.html");
    exit;

} catch (Exception $e) {
    echo '<div style="color:red;font-weight:bold;">Error: ' . htmlspecialchars($e->getMessage()) . '</div>';
}
?>
