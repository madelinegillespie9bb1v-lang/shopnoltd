<?php
// Enable error reporting for debugging during development
ini_set('display_errors', 1);
error_reporting(E_ALL);

// Log script execution start (useful for debugging)
error_log("Debug: Script started");

// Set Content-Type to JSON for all responses
header('Content-Type: application/json');

// Include database connection
include('index.html'); // Ensure this file contains `$conn` for database connection

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Get user input
    $fullName = $_POST['name'] ?? '';
    $email = $_POST['email'] ?? '';
    $amount = $_POST['amount'] ?? 0;

    // Validate inputs
    if (empty($fullName) || empty($email) || empty($amount)) {
        echo json_encode([
            'status' => 'error',
            'message' => 'All fields (name, email, and amount) are required.'
        ]);
        exit;
    }

    if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
        echo json_encode([
            'status' => 'error',
            'message' => 'Invalid email address.'
        ]);
        exit;
    }

    if ($amount <= 0) {
        echo json_encode([
            'status' => 'error',
            'message' => 'Donation amount must be greater than zero.'
        ]);
        exit;
    }

    // Generate a secure random token
    $login_token = bin2hex(random_bytes(16));

    // Use prepared statements to insert data securely
    $sql = "INSERT INTO donations (fullName, email, amount, currency, login_token, created_at) 
            VALUES (?, ?, ?, 'USD', ?, NOW())";
    $stmt = $conn->prepare($sql);
    if ($stmt) {
        $stmt->bind_param('ssds', $fullName, $email, $amount, $login_token); // Bind parameters securely
        if ($stmt->execute()) {
            // Get the ID of the newly inserted row
            $donor_id = $stmt->insert_id;

            // Return success response
            echo json_encode([
                'status' => 'success',
                'message' => 'Signup successful!',
                'token' => $login_token,
                'donor_id' => $donor_id
            ]);
        } else {
            // Handle execution error
            error_log("Database Error: " . $stmt->error); // Log error
            echo json_encode([
                'status' => 'error',
                'message' => 'Error saving data to database.'
            ]);
        }
        $stmt->close(); // Close statement
    } else {
        // Handle statement preparation error
        error_log("Statement Error: " . $conn->error); // Log error
        echo json_encode([
            'status' => 'error',
            'message' => 'Database error: Unable to prepare statement.'
        ]);
    }
} else {
    // Handle requests that are not POST
    echo json_encode([
        'status' => 'error',
        'message' => 'Invalid request method. Only POST requests are allowed.'
    ]);
}
?>
