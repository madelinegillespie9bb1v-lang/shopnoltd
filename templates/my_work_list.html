<?php
session_start();
require_once $_SERVER['DOCUMENT_ROOT'].'/config.html';
require_once $_SERVER['DOCUMENT_ROOT'].'/_common_rates_worker.html'; // worker-specific rates

// --- Enable error reporting temporarily for debugging ---
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

// ‚úÖ Check if user logged in
$user = $_SESSION['user'] ?? null;
if (!$user) {
    header('Location: /login.html');
    exit;
}

$username  = $user['username'] ?? '';
$user_role = $user['user_role'] ?? 'user';

// ‚úÖ Fetch all jobs worked on by this user
try {
    $stmt = $pdo->prepare("
        SELECT jw.*, j.platform, COALESCE(j.task_type, jw.category) AS category,
               j.title, j.description, j.per_task_rate
        FROM job_work jw
        LEFT JOIN jobs j ON jw.job_id = j.id
        WHERE jw.worker_username = ?
        ORDER BY jw.id DESC
    ");
    $stmt->execute([$username]);
    $works = $stmt->fetchAll(PDO::FETCH_ASSOC);
} catch (PDOException $e) {
    die("Database error: " . htmlspecialchars($e->getMessage()));
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Work List</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background:#f8f9fa; }
.table thead { background:#0d6efd; color:white; }
.instructions-box { background:#fffbea; border-left:5px solid #f0ad4e; padding:8px 12px; border-radius:6px; }
.copy-btn { margin-left:5px; }
</style>
</head>
<body>
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>üìù My Completed / In-progress Work (<?= count($works) ?>)</h3>
        <a href="<?= ($user_role === 'admin') ? '/admindashboard.html' : '/dashboard.html' ?>" class="btn btn-secondary">‚¨Ö Back</a>
    </div>

    <?php if (empty($works)): ?>
        <div class="alert alert-info">You haven't worked on any tasks yet.</div>
    <?php else: ?>
    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Job ID</th>
                    <th>Platform</th>
                    <th>Task Type / Category</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Job Link</th>
                    <th>Rate ($)</th>
                    <th>Screenshot Before</th>
                    <th>Screenshot After</th>
                    <th>Status</th>
                    <th>Submitted At</th>
                </tr>
            </thead>
            <tbody>
            <?php foreach ($works as $work): 
                $platform = $work['platform'] ?? '-';
                $category = $work['category'] ?? '-';
                $link = htmlspecialchars($work['job_link']);
                $before = $work['screenshot_before'] ? "<a href='".htmlspecialchars($work['screenshot_before'])."' target='_blank'>View</a>" : '-';
                $after  = $work['screenshot_after']  ? "<a href='".htmlspecialchars($work['screenshot_after'])."' target='_blank'>View</a>" : '-';
                $rate = isset($work['per_task_rate']) ? $work['per_task_rate'] : getTaskRate($platform, $category);
            ?>
                <tr>
                    <td><?= $work['id'] ?></td>
                    <td><?= $work['job_id'] ?></td>
                    <td><?= htmlspecialchars($platform) ?></td>
                    <td><?= htmlspecialchars($category) ?></td>
                    <td><?= htmlspecialchars($work['title'] ?? '-') ?></td>
                    <td><?= htmlspecialchars($work['description'] ?? '-') ?></td>
                    <td>
                        <?php if($link): ?>
                            <a href="<?= $link ?>" target="_blank" class="btn btn-sm btn-outline-primary">Open</a>
                            <button class="btn btn-sm btn-outline-secondary copy-btn" onclick="copyLink('<?= $link ?>')">Copy</button>
                        <?php else: ?>-<?php endif; ?>
                    </td>
                    <td><?= number_format($rate, 4) ?></td>
                    <td><?= $before ?></td>
                    <td><?= $after ?></td>
                    <td>
                        <?php
                            $status = strtolower($work['status']);
                            if ($status === 'pending') echo '<span class="badge bg-warning text-dark">Pending</span>';
                            elseif ($status === 'approved') echo '<span class="badge bg-success">Approved</span>';
                            elseif ($status === 'rejected') echo '<span class="badge bg-danger">Rejected</span>';
                            else echo '<span class="badge bg-secondary">'.htmlspecialchars($work['status']).'</span>';
                        ?>
                    </td>
                    <td><?= htmlspecialchars($work['submitted_at']) ?></td>
                </tr>
            <?php endforeach; ?>
            </tbody>
        </table>
    </div>
    <?php endif; ?>
</div>

<script>
function copyLink(link){
    navigator.clipboard.writeText(link).then(()=>{ alert('‚úÖ Link copied to clipboard!'); })
    .catch(()=>{ alert('‚ùå Failed to copy link.'); });
}
</script>
</body>
</html>
