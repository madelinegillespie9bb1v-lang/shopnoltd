<?php
session_start();

// Enable error reporting
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

// Include config


require_once __DIR__ . '/config.html';  // __DIR__ points to the folder



// Collect email safely
$email = trim($_POST['email'] ?? '');
$language = 'English';

// Check if email is provided
if (empty($email)) {
    echo "<script>alert('Please provide your email address!'); window.history.back();</script>";
    exit;
}

// Validate email format
if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
    echo "<script>alert('Invalid email address format!'); window.history.back();</script>";
    exit;
}

try {
    // Check if user exists by email
    $stmt = $pdo->prepare("SELECT * FROM users WHERE email = :email LIMIT 1");
    $stmt->execute([':email' => $email]);
    $user = $stmt->fetch(PDO::FETCH_ASSOC);

    if (!$user) {
        echo "<script>alert('No account found with this email!'); window.history.back();</script>";
        exit;
    }

    // Generate OTP
    $otp = random_int(100000, 999999);
    $otp_time = time();

    // Update OTP in DB
    $update = $pdo->prepare("UPDATE users SET otp = :otp, otp_time = NOW() WHERE id = :id");
    $update->execute([':otp' => $otp, ':id' => $user['id']]);

    // Store session for OTP verification
    $_SESSION['pending_user'] = [
        'id'         => $user['id'],
        'username'   => $user['username'],
        'email'      => $user['email'],
        'phone_code' => $user['phone_code'], // country code
        'phone'      => $user['phone'],      // phone number
        'language'   => $user['language'] ?? $language,
        'user_role'  => $user['user_role'],
        'otp'        => $otp,
        'otp_time'   => $otp_time,
        'otp_method' => 'browser'
    ];

    // Redirect to OTP verification page
    echo "<script>
        alert('Your Browser OTP is $otp. Please verify within 10 minutes.');
        window.location.href='verify_otp.html';
    </script>";
    exit;

} catch (PDOException $e) {
    echo "<script>alert('Database error: " . htmlspecialchars($e->getMessage()) . "'); window.history.back();</script>";
    exit;
} catch (Exception $e) {
    echo "<script>alert('Unexpected error: " . htmlspecialchars($e->getMessage()) . "'); window.history.back();</script>";
    exit;
}
?>
